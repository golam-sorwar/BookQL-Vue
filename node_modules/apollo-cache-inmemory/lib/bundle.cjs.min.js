exports.__esModule=!0,exports.assertIdValue=function(e){(0,i.invariant)((0,r.isIdValue)(e),5)},exports.defaultDataIdFromObject=j,exports.defaultNormalizedCacheFactory=function(e){return new x(e)},exports.enhanceErrorWithDocument=R,exports.WriteError=exports.StoreWriter=exports.StoreReader=exports.ObjectCache=exports.IntrospectionFragmentMatcher=exports.InMemoryCache=exports.HeuristicFragmentMatcher=void 0;var e=require("tslib"),t=require("apollo-cache"),r=require("apollo-utilities"),a=require("optimism"),i=require("ts-invariant"),n=new Map;if(n.set(1,2)!==n){var o=n.set;Map.prototype.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return o.apply(this,e),this}}var s=new Set;if(s.add(3)!==s){var c=s.add;Set.prototype.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return c.apply(this,e),this}}var u={};"function"==typeof Object.freeze&&Object.freeze(u);try{n.set(u,u).delete(u)}catch(e){var l=function(e){return e&&function(t){try{n.set(t,t).delete(t)}finally{return e.call(Object,t)}}};Object.freeze=l(Object.freeze),Object.seal=l(Object.seal),Object.preventExtensions=l(Object.preventExtensions)}var d=!1;function p(){var e=!d;return(0,r.isTest)()||(d=!0),e}var f=function(){function e(){}return e.prototype.ensureReady=function(){return Promise.resolve()},e.prototype.canBypassInit=function(){return!0},e.prototype.match=function(e,t,r){var a=r.store.get(e.id),i="ROOT_QUERY"===e.id;if(!a)return i;var n=a.__typename,o=void 0===n?i&&"Query":n;return o&&o===t||(p(),"heuristic")},e}();exports.HeuristicFragmentMatcher=f;var h=function(){function e(e){e&&e.introspectionQueryResultData?(this.possibleTypesMap=this.parseIntrospectionResult(e.introspectionQueryResultData),this.isReady=!0):this.isReady=!1,this.match=this.match.bind(this)}return e.prototype.match=function(e,t,r){(0,i.invariant)(this.isReady,10);var a=r.store.get(e.id),n="ROOT_QUERY"===e.id;if(!a)return n;var o=a.__typename,s=void 0===o?n&&"Query":o;if((0,i.invariant)(s,11),s===t)return!0;var c=this.possibleTypesMap[t];return!!(c&&c.indexOf(s)>-1)},e.prototype.parseIntrospectionResult=function(e){var t={};return e.__schema.types.forEach(function(e){"UNION"!==e.kind&&"INTERFACE"!==e.kind||(t[e.name]=e.possibleTypes.map(function(e){return e.name}))}),t},e}();exports.IntrospectionFragmentMatcher=h;var y=Object.prototype.hasOwnProperty,m=function(){function e(e){var t=this;void 0===e&&(e=Object.create(null)),this.data=e,this.depend=(0,a.wrap)(function(e){return t.data[e]},{disposable:!0,makeCacheKey:function(e){return e}})}return e.prototype.toObject=function(){return this.data},e.prototype.get=function(e){return this.depend(e),this.data[e]},e.prototype.set=function(e,t){t!==this.data[e]&&(this.data[e]=t,this.depend.dirty(e))},e.prototype.delete=function(e){y.call(this.data,e)&&(delete this.data[e],this.depend.dirty(e))},e.prototype.clear=function(){this.replace(null)},e.prototype.replace=function(e){var t=this;e?(Object.keys(e).forEach(function(r){t.set(r,e[r])}),Object.keys(this.data).forEach(function(r){y.call(e,r)||t.delete(r)})):Object.keys(this.data).forEach(function(e){t.delete(e)})},e}();function v(e){return new m(e)}var g=function(){function t(e){var t=this,i=void 0===e?{}:e,n=i.cacheKeyRoot,o=void 0===n?new a.KeyTrie(r.canUseWeakMap):n,s=i.freezeResults,c=void 0!==s&&s,u=this.executeStoreQuery,l=this.executeSelectionSet,d=this.executeSubSelectedArray;this.freezeResults=c,this.executeStoreQuery=(0,a.wrap)(function(e){return u.call(t,e)},{makeCacheKey:function(e){var t=e.query,r=e.rootValue,a=e.contextValue,i=e.variableValues,n=e.fragmentMatcher;if(a.store instanceof m)return o.lookup(a.store,t,n,JSON.stringify(i),r.id)}}),this.executeSelectionSet=(0,a.wrap)(function(e){return l.call(t,e)},{makeCacheKey:function(e){var t=e.selectionSet,r=e.rootValue,a=e.execContext;if(a.contextValue.store instanceof m)return o.lookup(a.contextValue.store,t,a.fragmentMatcher,JSON.stringify(a.variableValues),r.id)}}),this.executeSubSelectedArray=(0,a.wrap)(function(e){return d.call(t,e)},{makeCacheKey:function(e){var t=e.field,r=e.array,a=e.execContext;if(a.contextValue.store instanceof m)return o.lookup(a.contextValue.store,t,r,JSON.stringify(a.variableValues))}})}return t.prototype.readQueryFromStore=function(t){return this.diffQueryAgainstStore((0,e.__assign)({},t,{returnPartialData:!1})).result},t.prototype.diffQueryAgainstStore=function(e){var t=e.store,a=e.query,n=e.variables,o=e.previousResult,s=e.returnPartialData,c=void 0===s||s,u=e.rootId,l=void 0===u?"ROOT_QUERY":u,d=e.fragmentMatcherFunction,p=e.config,f=(0,r.getQueryDefinition)(a);n=(0,r.assign)({},(0,r.getDefaultValues)(f),n);var h={store:t,dataIdFromObject:p&&p.dataIdFromObject||null,cacheRedirects:p&&p.cacheRedirects||{}},y=this.executeStoreQuery({query:a,rootValue:{type:"id",id:l,generated:!0,typename:"Query"},contextValue:h,variableValues:n,fragmentMatcher:d}),m=y.missing&&y.missing.length>0;return m&&!c&&y.missing.forEach(function(e){if(!e.tolerable)throw new i.InvariantError(2)}),o&&(0,r.isEqual)(o,y.result)&&(y.result=o),{result:y.result,complete:!m}},t.prototype.executeStoreQuery=function(e){var t=e.query,a=e.rootValue,i=e.contextValue,n=e.variableValues,o=e.fragmentMatcher,s=void 0===o?S:o,c=(0,r.getMainDefinition)(t),u=(0,r.getFragmentDefinitions)(t),l={query:t,fragmentMap:(0,r.createFragmentMap)(u),contextValue:i,variableValues:n,fragmentMatcher:s};return this.executeSelectionSet({selectionSet:c.selectionSet,rootValue:a,execContext:l})},t.prototype.executeSelectionSet=function(t){var a=this,n=t.selectionSet,o=t.rootValue,s=t.execContext,c=s.fragmentMap,u=s.contextValue,l=s.variableValues,d={result:null},p=[],f=u.store.get(o.id),h=f&&f.__typename||"ROOT_QUERY"===o.id&&"Query"||void 0;function y(e){var t;return e.missing&&(d.missing=d.missing||[],(t=d.missing).push.apply(t,e.missing)),e.result}return n.selections.forEach(function(t){var n;if((0,r.shouldInclude)(t,l))if((0,r.isField)(t)){var d=y(a.executeField(f,h,t,s));void 0!==d&&p.push(((n={})[(0,r.resultKeyNameFromField)(t)]=d,n))}else{var m=void 0;if((0,r.isInlineFragment)(t))m=t;else if(!(m=c[t.name.value]))throw new i.InvariantError(3);var v=m.typeCondition.name.value,g=s.fragmentMatcher(o,v,u);if(g){var b=a.executeSelectionSet({selectionSet:m.selectionSet,rootValue:o,execContext:s});"heuristic"===g&&b.missing&&(b=(0,e.__assign)({},b,{missing:b.missing.map(function(t){return(0,e.__assign)({},t,{tolerable:!0})})})),p.push(y(b))}}}),d.result=(0,r.mergeDeepArray)(p),this.freezeResults,d},t.prototype.executeField=function(e,t,a,i){var n=i.variableValues,o=i.contextValue,s=function(e,t,a,i,n,o){o.resultKey;var s=o.directives,c=a;(i||s)&&(c=(0,r.getStoreKeyName)(c,i,s));var u=void 0;if(e&&void 0===(u=e[c])&&n.cacheRedirects&&"string"==typeof t){var l=n.cacheRedirects[t];if(l){var d=l[a];d&&(u=d(e,i,{getCacheKey:function(e){return(0,r.toIdValue)({id:n.dataIdFromObject(e),typename:e.__typename})}}))}}if(void 0===u)return{result:u,missing:[{object:e,fieldName:c,tolerable:!1}]};(0,r.isJsonValue)(u)&&(u=u.json);return{result:u}}(e,t,a.name.value,(0,r.argumentsObjectFromField)(a,n),o,{resultKey:(0,r.resultKeyNameFromField)(a),directives:(0,r.getDirectiveInfoFromField)(a,n)});return Array.isArray(s.result)?this.combineExecResults(s,this.executeSubSelectedArray({field:a,array:s.result,execContext:i})):a.selectionSet?null==s.result?s:this.combineExecResults(s,this.executeSelectionSet({selectionSet:a.selectionSet,rootValue:s.result,execContext:i})):(b(a,s.result),this.freezeResults,s)},t.prototype.combineExecResults=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=null;return e.forEach(function(e){e.missing&&(r=r||[]).push.apply(r,e.missing)}),{result:e.pop().result,missing:r}},t.prototype.executeSubSelectedArray=function(e){var t=this,r=e.field,a=e.array,i=e.execContext,n=null;function o(e){return e.missing&&(n=n||[]).push.apply(n,e.missing),e.result}return a=a.map(function(e){return null===e?null:Array.isArray(e)?o(t.executeSubSelectedArray({field:r,array:e,execContext:i})):r.selectionSet?o(t.executeSelectionSet({selectionSet:r.selectionSet,rootValue:e,execContext:i})):(b(r,e),e)}),this.freezeResults,{result:a,missing:n}},t}();function b(e,t){if(!e.selectionSet&&(0,r.isIdValue)(t))throw new i.InvariantError(4)}function S(){return!0}exports.StoreReader=g;var x=function(){function e(e){void 0===e&&(e=Object.create(null)),this.data=e}return e.prototype.toObject=function(){return this.data},e.prototype.get=function(e){return this.data[e]},e.prototype.set=function(e,t){this.data[e]=t},e.prototype.delete=function(e){this.data[e]=void 0},e.prototype.clear=function(){this.data=Object.create(null)},e.prototype.replace=function(e){this.data=e||Object.create(null)},e}();exports.ObjectCache=x;var O=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="WriteError",e}return(0,e.__extends)(r,t),r}(Error);function R(e,t){var r=new O("Error writing result to store for query:\n "+JSON.stringify(t));return r.message+="\n"+e.message,r.stack=e.stack,r}exports.WriteError=O;var I=function(){function t(){}return t.prototype.writeQueryToStore=function(e){var t=e.query,r=e.result,a=e.store,i=void 0===a?v():a,n=e.variables,o=e.dataIdFromObject,s=e.fragmentMatcherFunction;return this.writeResultToStore({dataId:"ROOT_QUERY",result:r,document:t,store:i,variables:n,dataIdFromObject:o,fragmentMatcherFunction:s})},t.prototype.writeResultToStore=function(e){var t=e.dataId,a=e.result,i=e.document,n=e.store,o=void 0===n?v():n,s=e.variables,c=e.dataIdFromObject,u=e.fragmentMatcherFunction,l=(0,r.getOperationDefinition)(i);try{return this.writeSelectionSetToStore({result:a,dataId:t,selectionSet:l.selectionSet,context:{store:o,processedData:{},variables:(0,r.assign)({},(0,r.getDefaultValues)(l),s),dataIdFromObject:c,fragmentMap:(0,r.createFragmentMap)((0,r.getFragmentDefinitions)(i)),fragmentMatcherFunction:u}})}catch(e){throw R(e,i)}},t.prototype.writeSelectionSetToStore=function(e){var t=this,a=e.result,n=e.dataId,o=e.selectionSet,s=e.context,c=s.variables,u=s.store,l=s.fragmentMap;return o.selections.forEach(function(e){var o;if((0,r.shouldInclude)(e,c))if((0,r.isField)(e)){var u=(0,r.resultKeyNameFromField)(e),d=a[u];if(void 0!==d)t.writeFieldToStore({dataId:n,value:d,field:e,context:s});else{var p=!1,f=!1;e.directives&&e.directives.length&&(p=e.directives.some(function(e){return e.name&&"defer"===e.name.value}),f=e.directives.some(function(e){return e.name&&"client"===e.name.value})),!p&&!f&&s.fragmentMatcherFunction}}else{var h=void 0;(0,r.isInlineFragment)(e)?h=e:(h=(l||{})[e.name.value],(0,i.invariant)(h,6));var y=!0;if(s.fragmentMatcherFunction&&h.typeCondition){var m=n||"self",v=(0,r.toIdValue)({id:m,typename:void 0}),g={store:new x((o={},o[m]=a,o)),cacheRedirects:{}},b=s.fragmentMatcherFunction(v,h.typeCondition.name.value,g);(0,r.isProduction)(),y=!!b}y&&t.writeSelectionSetToStore({result:a,selectionSet:h.selectionSet,dataId:n,context:s})}}),u},t.prototype.writeFieldToStore=function(t){var a,n,o,s=t.field,c=t.value,u=t.dataId,l=t.context,d=l.variables,p=l.dataIdFromObject,f=l.store,h=(0,r.storeKeyNameFromField)(s,d);if(s.selectionSet&&null!==c)if(Array.isArray(c)){var y=u+"."+h;n=this.processArrayValue(c,y,s.selectionSet,l)}else{var m=u+"."+h,v=!0;if(F(m)||(m="$"+m),p){var g=p(c);(0,i.invariant)(!g||!F(g),7),(g||"number"==typeof g&&0===g)&&(m=g,v=!1)}w(m,s,l.processedData)||this.writeSelectionSetToStore({dataId:m,result:c,selectionSet:s.selectionSet,context:l});var b=c.__typename;n=(0,r.toIdValue)({id:m,typename:b},v);var S=(o=f.get(u))&&o[h];if(S!==n&&(0,r.isIdValue)(S)){var x=void 0!==S.typename,O=void 0!==b,R=x&&O&&S.typename!==b;(0,i.invariant)(!v||S.generated||R,8),(0,i.invariant)(!x||O,9),S.generated&&(R?v||f.delete(S.id):function t(a,i,n){if(a===i)return!1;var o=n.get(a);var s=n.get(i);var c=!1;Object.keys(o).forEach(function(e){var a=o[e],i=s[e];(0,r.isIdValue)(a)&&F(a.id)&&(0,r.isIdValue)(i)&&!(0,r.isEqual)(a,i)&&t(a.id,i.id,n)&&(c=!0)});n.delete(a);var u=(0,e.__assign)({},o,s);if((0,r.isEqual)(u,s))return c;n.set(i,u);return!0}(S.id,n.id,f))}}else n=null!=c&&"object"==typeof c?{type:"json",json:c}:c;(o=f.get(u))&&(0,r.isEqual)(n,o[h])||f.set(u,(0,e.__assign)({},o,((a={})[h]=n,a)))},t.prototype.processArrayValue=function(e,t,a,i){var n=this;return e.map(function(e,o){if(null===e)return null;var s=t+"."+o;if(Array.isArray(e))return n.processArrayValue(e,s,a,i);var c=!0;if(i.dataIdFromObject){var u=i.dataIdFromObject(e);u&&(s=u,c=!1)}return w(s,a,i.processedData)||n.writeSelectionSetToStore({dataId:s,result:e,selectionSet:a,context:i}),(0,r.toIdValue)({id:s,typename:e.__typename},c)})},t}();function F(e){return"$"===e[0]}function w(e,t,r){if(!r)return!1;if(r[e]){if(r[e].indexOf(t)>=0)return!0;r[e].push(t)}else r[e]=[t];return!1}exports.StoreWriter=I;var _={fragmentMatcher:new f,dataIdFromObject:j,addTypename:!0,resultCaching:!0,freezeResults:!1};function j(e){if(e.__typename){if(void 0!==e.id)return e.__typename+":"+e.id;if(void 0!==e._id)return e.__typename+":"+e._id}return null}var V=Object.prototype.hasOwnProperty,M=function(t){function r(e,r,a){var i=t.call(this,Object.create(null))||this;return i.optimisticId=e,i.parent=r,i.transaction=a,i}return(0,e.__extends)(r,t),r.prototype.toObject=function(){return(0,e.__assign)({},this.parent.toObject(),this.data)},r.prototype.get=function(e){return V.call(this.data,e)?this.data[e]:this.parent.get(e)},r}(x),D=function(t){function n(i){void 0===i&&(i={});var n=t.call(this)||this;n.watches=new Set,n.typenameDocumentCache=new Map,n.cacheKeyRoot=new a.KeyTrie(r.canUseWeakMap),n.silenceBroadcast=!1,n.config=(0,e.__assign)({},_,i),n.config.customResolvers&&(n.config.cacheRedirects=n.config.customResolvers),n.config.cacheResolvers&&(n.config.cacheRedirects=n.config.cacheResolvers),n.addTypename=n.config.addTypename,n.data=n.config.resultCaching?new m:new x,n.optimisticData=n.data,n.storeWriter=new I,n.storeReader=new g({cacheKeyRoot:n.cacheKeyRoot,freezeResults:i.freezeResults});var o=n,s=o.maybeBroadcastWatch;return n.maybeBroadcastWatch=(0,a.wrap)(function(e){return s.call(n,e)},{makeCacheKey:function(e){if(!e.optimistic&&!e.previousResult)return o.data instanceof m?o.cacheKeyRoot.lookup(e.query,JSON.stringify(e.variables)):void 0}}),n}return(0,e.__extends)(n,t),n.prototype.restore=function(e){return e&&this.data.replace(e),this},n.prototype.extract=function(e){return void 0===e&&(e=!1),(e?this.optimisticData:this.data).toObject()},n.prototype.read=function(e){return"string"==typeof e.rootId&&void 0===this.data.get(e.rootId)?null:this.storeReader.readQueryFromStore({store:e.optimistic?this.optimisticData:this.data,query:this.transformDocument(e.query),variables:e.variables,rootId:e.rootId,fragmentMatcherFunction:this.config.fragmentMatcher.match,previousResult:e.previousResult,config:this.config})},n.prototype.write=function(e){this.storeWriter.writeResultToStore({dataId:e.dataId,result:e.result,variables:e.variables,document:this.transformDocument(e.query),store:this.data,dataIdFromObject:this.config.dataIdFromObject,fragmentMatcherFunction:this.config.fragmentMatcher.match}),this.broadcastWatches()},n.prototype.diff=function(e){return this.storeReader.diffQueryAgainstStore({store:e.optimistic?this.optimisticData:this.data,query:this.transformDocument(e.query),variables:e.variables,returnPartialData:e.returnPartialData,previousResult:e.previousResult,fragmentMatcherFunction:this.config.fragmentMatcher.match,config:this.config})},n.prototype.watch=function(e){var t=this;return this.watches.add(e),function(){t.watches.delete(e)}},n.prototype.evict=function(e){throw new i.InvariantError(1)},n.prototype.reset=function(){return this.data.clear(),this.broadcastWatches(),Promise.resolve()},n.prototype.removeOptimistic=function(e){for(var t=[],r=0,a=this.optimisticData;a instanceof M;)a.optimisticId===e?++r:t.push(a),a=a.parent;if(r>0){for(this.optimisticData=a;t.length>0;){var i=t.pop();this.performTransaction(i.transaction,i.optimisticId)}this.broadcastWatches()}},n.prototype.performTransaction=function(e,t){var r=this.data,a=this.silenceBroadcast;this.silenceBroadcast=!0,"string"==typeof t&&(this.data=this.optimisticData=new M(t,this.optimisticData,e));try{e(this)}finally{this.silenceBroadcast=a,this.data=r}this.broadcastWatches()},n.prototype.recordOptimisticTransaction=function(e,t){return this.performTransaction(e,t)},n.prototype.transformDocument=function(e){if(this.addTypename){var t=this.typenameDocumentCache.get(e);return t||(t=(0,r.addTypenameToDocument)(e),this.typenameDocumentCache.set(e,t),this.typenameDocumentCache.set(t,t)),t}return e},n.prototype.broadcastWatches=function(){var e=this;this.silenceBroadcast||this.watches.forEach(function(t){return e.maybeBroadcastWatch(t)})},n.prototype.maybeBroadcastWatch=function(e){e.callback(this.diff({query:e.query,variables:e.variables,previousResult:e.previousResult&&e.previousResult(),optimistic:e.optimistic}))},n}(t.ApolloCache);exports.InMemoryCache=D;
